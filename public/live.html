<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Question</title>
  <link id="theme-stylesheet" rel="stylesheet" href="/themes/live/default.css">
</head>
<body>
  <div id="live-question-container">
    <div id="qr-code-container" style="margin-bottom: 20px;"></div>
    <div id="event-name">VBC Live Event</div>
    <div id="live-question"></div>
    <div id="username"></div>
    <div id="event-url">Event URL: Not Set</div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/AdditionalLibraries/qrcode.js"></script>
  <script>
    // Test for Connection
    const socket = io();
    const myView = 'live';
    function applyThemeForView(themeFilename) {
      const link = document.getElementById('theme-stylesheet');
      if (link && themeFilename) link.href = '/themes/' + themeFilename;
    }
    socket.on('connect', () => {
      console.log('Connected to server:', socket.id);
    });
    // END TEST
    const display = document.getElementById('live-question');
    const user = document.getElementById('username');
    const eventName = document.getElementById('event-name');
    const eventUrl = document.getElementById('event-url');
    const qrCodeContainer = document.getElementById('qr-code-container');

    let currentEventName = 'VBC Live Event'; // Default event name
    let currentEventURL = 'Event URL: Not Set'; // Default event URL

    socket.on('live_question', (question) => {
      const eventNameContainer = document.getElementById('event-name');
      const eventUrlContainer = document.getElementById('event-url');
      const liveQuestionContainer = document.getElementById('live-question');
      const usernameContainer = document.getElementById('username');

      if (question) {
        // Display the live question and username
        user.textContent = question.username ? `- ${question.username}` : '- Anonymous';
        display.textContent = question.text;

        // Hide Event Name and Event URL
        eventNameContainer.style.display = 'none';
        eventUrlContainer.style.display = 'none';
        qrCodeContainer.style.display = 'none';

        // Show live question and username
        liveQuestionContainer.style.display = 'block';
        usernameContainer.style.display = 'block';
      } else {
        // Clear the live question display and show the participant view URL
        user.textContent = '';
        display.textContent = '';

        // Show Event Name and Event URL
        eventNameContainer.style.display = 'block';
        eventUrlContainer.style.display = 'block';
        qrCodeContainer.style.display = 'block';

        // Hide live question and username
        liveQuestionContainer.style.display = 'none';
        usernameContainer.style.display = 'none';

        // Restore the stored values for Event Name and Event URL
        eventName.textContent = currentEventName;
        eventUrl.textContent = currentEventURL;
      }
    });

    // Load values from localStorage on initial page load
    window.addEventListener('load', () => {
      const storedEventName = localStorage.getItem('live_eventName');
      const storedEventURL = localStorage.getItem('live_eventIP');

      // If values exist in localStorage, update the DOM
      if (storedEventName) {
        currentEventName = storedEventName; // Update the stored value
        eventName.textContent = currentEventName; // Update the DOM
      }

      if (storedEventURL) {
        currentEventURL = storedEventURL; // Update the stored value
        eventUrl.textContent = `To submit questions, please visit ${storedEventURL}`; // Update the DOM
        generateQRCode(currentEventURL); // Generate QR code for the stored URL
      }
    });

    // Listen for event name updates and save to localStorage
    socket.on('event_name_updated', ({ eventName: updatedEventName }) => {
      currentEventName = updatedEventName; // Update the stored value
      eventName.textContent = currentEventName; // Update the DOM
      localStorage.setItem('live_eventName', currentEventName); // Save the updated value to localStorage
    });

    // Listen for event URL updates and save to localStorage
    socket.on('event_url_updated', ({ eventURL }) => {
      currentEventURL = eventURL; // Store the raw URL
      eventUrl.textContent = `To submit questions, please visit ${eventURL}`; // Update the DOM with the concatenated string
      localStorage.setItem('live_eventIP', currentEventURL); // Save the raw URL to localStorage
      generateQRCode(currentEventURL); // Generate QR code for the raw URL
    });

    // Apply theme updates from server
    socket.on('theme_updated', (themes) => {
      if (themes && themes[myView]) applyThemeForView(themes[myView]);
    });

    // Function to generate a QR code
    function generateQRCode(url) {
      // debugging - log the URL being used for QR code generation
      console.log('Generating QR code for URL:', url);

      // Clear any existing QR code
      qrCodeContainer.innerHTML = '';

      // Generate a new QR code
      new QRCode(qrCodeContainer, {
        text: url, // Use the provided URL
        width: 512, // Width of the QR code
        height: 512, // Height of the QR code
        colorDark: "#000000", // Dark color
        colorLight: "#ffffff", // Light color
        correctLevel: QRCode.CorrectLevel.L // Error correction level
      });
    }
    
  </script>
</body>
</html>